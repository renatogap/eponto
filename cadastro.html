<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Teste Facial Local</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">


<style>
  video { width: 100%; border-radius: 10px; }
  .btn-ponto { font-size: 1.2rem; height: 70px; }
</style>
</head>
<body class="bg-light">

<div class="container mt-3">

  <h5>Cadastro do Rosto</h5>

  <div class="card mb-3 shadow-sm">
    <div class="card-body text-center">
      <video id="video" autoplay muted></video>
      <p id="statusFace" class="fw-bold text-warning mt-2">Aguardando rosto...</p>
    </div>
  </div>

  <div class="d-grid gap-2">
    <button id="btnCadastro" class="btn btn-primary btn-ponto">Cadastrar Rosto</button>
    <button id="btnVerificar" class="btn btn-success btn-ponto">Bater Ponto</button>
  </div>

  <div class="mt-3">
    <p id="resultado" class="fw-bold"></p>
  </div>

</div>

<!-- Navbar inferior -->
<nav class="navbar fixed-bottom navbar-light bg-white border-top">
    <div class="container d-flex justify-content-around">
        <a href="ponto-face.html" class="text-primary text-center">
            <i class="bi bi-clock fs-4"></i><br>Ponto
        </a>
        <a href="ajuste.html" class="text-dark text-center">
            <i class="bi bi-pencil-square fs-4"></i><br>Ajuste
        </a>
        <a href="espelho.html" class="text-dark text-center">
            <i class="bi bi-list-check fs-4"></i><br>Espelho
        </a>
        <a href="cadastro.html" class="text-dark text-center">
            <i class="bi bi-people fs-4"></i><br>Cadastro
        </a>
    </div>
</nav>

<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<script>
const video = document.getElementById('video');
const statusFace = document.getElementById('statusFace');
const resultado = document.getElementById('resultado');

async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
  video.srcObject = stream;
}

async function carregarModelos() {
  const MODEL_URL = '/models';
  
  await Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
  ]);
}

video.addEventListener('play', () => {
  setInterval(async () => {
    const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
    if(detection) {
      statusFace.innerText = 'Rosto detectado ✔';
      statusFace.className = 'fw-bold text-success mt-2';
    } else {
      statusFace.innerText = 'Aguardando rosto...';
      statusFace.className = 'fw-bold text-warning mt-2';
    }
  }, 500);
});

// Captura o descritor do rosto
async function capturarDescritor() {
  const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
  if(detection) return Array.from(detection.descriptor);
  else return null;
}

// Botão cadastrar
document.getElementById('btnCadastro').addEventListener('click', async () => {
  const descritor = await capturarDescritor();
  if(!descritor) {
    resultado.innerText = 'Rosto não detectado. Tente novamente!';
    resultado.className = 'text-danger fw-bold';
    return;
  }
  localStorage.setItem('faceDescriptor', JSON.stringify(descritor));
  resultado.innerText = 'Rosto cadastrado com sucesso!';
  resultado.className = 'text-success fw-bold';
});

// Botão verificar
document.getElementById('btnVerificar').addEventListener('click', async () => {
  const descritorNovo = await capturarDescritor();
  if(!descritorNovo) {
    resultado.innerText = 'Rosto não detectado. Tente novamente!';
    resultado.className = 'text-danger fw-bold';
    return;
  }

  const descritorSalvo = JSON.parse(localStorage.getItem('faceDescriptor'));
  if(!descritorSalvo) {
    resultado.innerText = 'Nenhum rosto cadastrado!';
    resultado.className = 'text-warning fw-bold';
    return;
  }

  // Calcula distância euclidiana
  const distancia = faceapi.euclideanDistance(descritorNovo, descritorSalvo);

  if(distancia < 0.6) {
    resultado.innerText = `Rosto validado! Distância: ${distancia.toFixed(3)}`;
    resultado.className = 'text-success fw-bold';
  } else {
    resultado.innerText = `Rosto NÃO confere. Distância: ${distancia.toFixed(3)}`;
    resultado.className = 'text-danger fw-bold';
  }
});

// Init
(async () => {
  await carregarModelos();
  await startCamera();
})();
</script>

</body>
</html>
