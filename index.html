<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Bater Ponto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    .btn-ponto {
      height: 90px;
      font-size: 1.3rem;
    }
    #boxFace {
      height: 250px;
      width: 100%;
      overflow: hidden;
      border-radius: 10px;
    }
    video {
      width: 100%;
      border-radius: 10px;
      
    }
    #faceStatus {
      position: sticky;
      margin-top: -1em;
    }
    .hora-atual {
      font-size: 2.2rem;
      font-weight: bold;
    }
    #btnEntrada, #btnSaida {
      display: none;
    }
  </style>
</head>
<body class="bg-light pb-5">
    
    <!-- Modal de Loading -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-3">
                <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <div class="mt-3 fw-bold">Registrando ponto...</div>
            </div>
        </div>
    </div>

    <div class="container mt-3">
        <h5>Ol√°, Renato üëã</h5>

        <!-- Camera -->
        <div class="card shadow-sm text-center">
            <div class="card-body">
              <div id="dataAtual" class="text-muted"></div>
              <div id="horaAtual" class="hora-atual"></div>
            
              <div id="boxFace">
                <video id="video" autoplay muted></video>
              </div>

              <p id="faceStatus" class="mt-2 text-warning fw-bold">
                  Aguardando rosto...
              </p>

              <div id="statusDia"></div>

              <button id="btnEntrada" class="btn btn-success w-100 mb-2" disabled>
                <i class="bi bi-box-arrow-in-right"></i>
                Bater Entrada
              </button>
              
              <button id="btnSaida" class="btn btn-danger w-100" disabled>
                <i class="bi bi-box-arrow-left"></i>
                Bater Sa√≠da
              </button>
            </div>
        </div>
    </div>

    <!-- Navbar inferior -->
    <nav class="navbar fixed-bottom navbar-light bg-white border-top">
        <div class="container d-flex justify-content-around">
            <a href="index.html" class="text-primary text-center">
                <i class="bi bi-clock fs-4"></i><br>Ponto
            </a>
            <a href="ajuste.html" class="text-dark text-center">
                <i class="bi bi-pencil-square fs-4"></i><br>Ajuste
            </a>
            <a href="espelho.html" class="text-dark text-center">
                <i class="bi bi-list-check fs-4"></i><br>Espelho
            </a>
            <a href="cadastro.html" class="text-dark text-center">
                <i class="bi bi-people fs-4"></i><br>Cadastro
            </a>
        </div>
    </nav>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<!-- Face API -->
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<script>
    
/* ===========================
   DATA / HORA
=========================== */
function atualizarHora() {
  const agora = new Date();
  document.getElementById('horaAtual').innerText = agora.toLocaleTimeString('pt-BR');
  document.getElementById('dataAtual').innerText = agora.toLocaleDateString('pt-BR', {
                                                      weekday: 'long',
                                                      day: '2-digit',
                                                      month: '2-digit',
                                                      year: 'numeric'
                                                    });
}
setInterval(atualizarHora, 1000);
atualizarHora();

/* ===========================
   FACE API
=========================== */
const video = document.getElementById('video');
const faceStatus = document.getElementById('faceStatus');
const boxFace = document.getElementById('boxFace');
const btnEntrada = document.getElementById('btnEntrada');
const btnSaida = document.getElementById('btnSaida');
const statusDia = document.getElementById('statusDia');
// const MODEL_URL = '/models';
const MODEL_URL = 'https://renatogap.github.io/eponto/models';

let historico = JSON.parse(localStorage.getItem('historicoPonto')) || [];

window.onload = async () => {
    if (historico.length >= 2) {
      window.location = 'historico.html';
      return;
    }

    async function iniciarCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'user' }
        });
        video.srcObject = stream;
    }

    async function carregarModelos() {
        
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
        ]);
    }

    await carregarModelos();
    await iniciarCamera();

    //Mostrar e esconder bot√µes
    if(historico.length > 0) {
      
        btnSaida.style.display = 'block'
        btnEntrada.style.display = 'none'
      
    }
};



video.addEventListener('play', () => {
  setInterval(async () => {
    const detection = await faceapi.detectSingleFace(
      video,
      new faceapi.TinyFaceDetectorOptions()
    );

    if (detection) {
      faceStatus.innerText = 'Rosto detectado ‚úî';
      faceStatus.className = 'mt-2 text-success fw-bold';
      btnEntrada.disabled = false;
      btnSaida.disabled = false;
    } else {
      faceStatus.innerText = 'Aguardando rosto...';
      faceStatus.className = 'mt-2 text-warning fw-bold';
      btnEntrada.disabled = false;
      btnSaida.disabled = false;
    }
  }, 1000);
});


// Captura o descritor do rosto
  async function capturarDescritor() {
    const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
    
    if(detection) 
      return Array.from(detection.descriptor);
    else 
      return null;
  }

  function getDescritorFacialCadastro() {
    const descritorCadastro = JSON.parse(localStorage.getItem('faceDescriptor'));

    if(!descritorCadastro)
      return null;

    return descritorCadastro;
  }

  btnEntrada.addEventListener('click', async () => {
    btnEntrada.disabled = true;
    
    const descritorNovo = await capturarDescritor();
    if(!descritorNovo) {
      statusDia.innerText = 'Rosto n√£o detectado. Tente novamente!';
      statusDia.className = 'text-danger fw-bold';
      return;
    }

    const descritorSalvo = getDescritorFacialCadastro();
    if(!descritorSalvo) {
      statusDia.innerText = 'Nenhum rosto cadastrado!';
      statusDia.className = 'text-warning fw-bold';
      return;
    }

    // Calcula dist√¢ncia euclidiana
    const distancia = faceapi.euclideanDistance(descritorNovo, descritorSalvo);

    if(distancia >= 0.6) {
        statusDia.innerText = `Rosto N√ÉO confere. Dist√¢ncia: ${distancia.toFixed(3)}`;
        statusDia.className = 'text-danger fw-bold';
        return;
    } 

    statusDia.innerText = `Funcionou. Dist√¢ncia: ${distancia.toFixed(3)}`;
    statusDia.className = 'text-success fw-bold';

    // Mostra modal de loading
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();

    // Salva os dados no sessionStorage para a pr√≥xima p√°gina
    salvarHistorico('Entrada', 'Renato Pereira'); 

    // Simula 1 segundo de loading
    setTimeout(() => {        
        window.location.href = 'ponto-sucesso.html';
    }, 1000);

    
    

    // Exemplo de integra√ß√£o futura:
    // fetch('/ponto/entrada', { method: 'POST' });
  });

  btnSaida.addEventListener('click', async() => {
    
    const descritorNovo = await capturarDescritor();
    if(!descritorNovo) {
      statusDia.innerText = 'Rosto n√£o detectado. Tente novamente!';
      statusDia.className = 'text-danger fw-bold';
      return;
    }

    const descritorSalvo = getDescritorFacialCadastro();
    if(!descritorSalvo) {
      statusDia.innerText = 'Nenhum rosto cadastrado!';
      statusDia.className = 'text-warning fw-bold';
      return;
    }

    // Calcula dist√¢ncia euclidiana
    const distancia = faceapi.euclideanDistance(descritorNovo, descritorSalvo);

    if(distancia >= 0.6) {
        statusDia.innerText = `Rosto N√ÉO confere. Dist√¢ncia: ${distancia.toFixed(3)}`;
        statusDia.className = 'text-danger fw-bold';
        return;      
    } 

    btnSaida.disabled = true;

    // Mostra modal de loading
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();

    // Salva os dados no sessionStorage para a pr√≥xima p√°gina
    salvarHistorico('Saida', 'Renato Pereira'); 

    // Simula 1 segundo de loading
    setTimeout(() => {        
        window.location.href = 'ponto-sucesso.html';
    }, 1000);
    

    // fetch('/ponto/saida', { method: 'POST' });
  });

  // Fun√ß√£o auxiliar para salvar no hist√≥rico
    function salvarHistorico(tipo, nome) {
        const agora = new Date();

        const registro = {
            tipo: tipo,
            hora: agora.toLocaleTimeString('pt-BR'),
            data: agora.toLocaleDateString('pt-BR'),
            nome: nome
        };

        sessionStorage.setItem("tipoPonto", tipo);
        sessionStorage.setItem("horaPonto", registro.hora);
        sessionStorage.setItem("dataPonto", registro.data);
        sessionStorage.setItem("nomeFuncionario", nome);


        let historico = JSON.parse(localStorage.getItem('historicoPonto')) || [];
        historico.push(registro);
        localStorage.setItem('historicoPonto', JSON.stringify(historico));
    }


</script>

</body>
</html>
